#+SEQ_TODO: TODO STARTED | DONE
#+OPTIONS: num:nil

* STARTED Introduction

  The ~compoutation.environment~ library provides protocols and
  implementations for environments, that is data structures which
  bindings of names to values. Different kinds of environments are
  available:

  + Global environments
  + Lexical environments

  Lexical environments can be organized in a hierarchy such that child
  environments inherit entries from their ancestors.

  Another feature are first-class namespaces: environments contain
  namespace which in turn control how names are organized and
  processed within the environment.

* TODO Concepts

  + namespace ::

    + Name syntax

    + Name comparison

    + Entry isolation

  + environment ::

  + binding ::

* STARTED Tutorial

  #+BEGIN_SRC lisp :exports results :results silent
    (ql:quickload :computation.environment)
  #+END_SRC

** STARTED Making environments

   #+BEGIN_SRC lisp :exports both :results output
     (defvar *environment* (make-instance 'computation.environment:global-environment))

     (setf (computation.environment:lookup 'function 'computation.environment::namespace *environment*)
           (make-instance 'computation.environment::eq-namespace))

     (describe *environment*)
   #+END_SRC

   #+RESULTS:
   : #<GLOBAL-ENVIRONMENT 1 namespace {10028B3063}>
   :
   :   EQ-NAMESPACE COMMON-LISP:FUNCTION 0 entries
   :

** STARTED Looking up bindings

   #+BEGIN_SRC lisp :exports both
     (handler-case
         (computation.environment:lookup 'foo 'function *environment*)
       (error (condition)
         (princ-to-string condition)))
   #+END_SRC

   #+RESULTS:
   : An entry for name FOO does not exist in namespace FUNCTION in environment
   : #<GLOBAL-ENVIRONMENT 1 namespace {10028B3063}>

   #+BEGIN_SRC lisp :exports both
     (computation.environment:entries 'function *environment*)
   #+END_SRC

   #+RESULTS:
   : NIL

** STARTED Adding bindings

   New bindings can be created in two ways

   1. Destructively modifying a given environment by adding the new
      binding to it

   2. Creating a new environment object that contains the new binding
      and is linked to the existing environment object

   The first way can be achieved using the ~(setf
   computation.environment:lookup)~ generic function:

   #+BEGIN_SRC lisp :exports both
     (setf (computation.environment:lookup 'foo 'function *environment*) :foo)
     (computation.environment:lookup 'foo 'function *environment*)
   #+END_SRC

   #+RESULTS:
   : :FOO

   The functions ~computation.environment:augmented-environment~ and
   ~computation.environment:augmented-namespace~ implement the second
   way:

   #+BEGIN_SRC lisp :exports both :results output
     (let ((augmented (computation.environment:augmented-namespace
                       *environment* 'function '(bar) '(:bar)
                       :class 'computation.environment::lexical-environment)))
       (describe augmented)
       (clouseau:inspect augmented :new-process t)
       (handler-case
           (computation.environment:lookup 'bar 'function augmented)
         (error (condition)
           (princ-to-string condition))))
   #+END_SRC

   #+RESULTS:
   : #<LEXICAL-ENVIRONMENT 1 namespace @1 {1011E28F13}>
   :
   :   EQ-NAMESPACE COMMON-LISP:FUNCTION 2 entries
   :     BAR → :BAR
   :     FOO → :FOO [inherited from #<GLOBAL-ENVIRONMENT 2 namespaces {10028B3063}>]

   but the original environment is not affected:

   #+BEGIN_SRC lisp :exports both :results output
     (describe *environment*)
   #+END_SRC

   #+RESULTS:
   : #<GLOBAL-ENVIRONMENT 2 namespaces {10028B3063}>
   :
   :   EQ-NAMESPACE COMMON-LISP:FUNCTION 1 entry
   :     FOO → :FOO

** TODO Shadowing

   #+BEGIN_SRC lisp :exports both :results output
     (let ((augmented (computation.environment:augmented-namespace
                       ,*environment* 'function '(foo) '(:bar)
                       :class 'computation.environment::lexical-environment)))
       (describe *environment*)
       (terpri) (terpri)
       (describe augmented) (clouseau:inspect augmented :new-process t))
   #+END_SRC

   #+RESULTS:
   #+begin_example
   #<GLOBAL-ENVIRONMENT 2 namespaces {10028B3063}>

     EQ-NAMESPACE COMMON-LISP:FUNCTION 1 entry
       FOO → :FOO

   #<LEXICAL-ENVIRONMENT 1 namespace @1 {1005097E73}>

     EQ-NAMESPACE COMMON-LISP:FUNCTION 2 entries
       FOO → :BAR
       FOO → :FOO [inherited from #<GLOBAL-ENVIRONMENT 2 namespaces {10028B3063}>]
   #+end_example

* TODO Dictionary
